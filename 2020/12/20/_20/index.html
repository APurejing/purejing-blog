<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>WEB鉴权机制 | APureingJing</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="由于 HTTP 协议本身是无状态的，所以客户端同服务端通信时，服务端并不知道每次通信时，与之通信的是哪个客户端，再加上服务器资源并不是向所有用户开放的，而是仅对部分用户登陆，在这种情况下，实现用户的鉴权登陆是一种必要需求。

开发中常用到用户鉴权登陆方式，一般有四种：

HTTP Basic Authentication
session-cookie
Token
OAuth ...">
    
    <link rel="preload" href="/purejing-blog/assets/css/0.styles.c06caa5c.css" as="style"><link rel="preload" href="/purejing-blog/assets/js/app.1ccd296c.js" as="script"><link rel="preload" href="/purejing-blog/assets/js/6.a2607acc.js" as="script"><link rel="preload" href="/purejing-blog/assets/js/3.f5077034.js" as="script"><link rel="preload" href="/purejing-blog/assets/js/13.f515bb59.js" as="script"><link rel="prefetch" href="/purejing-blog/assets/js/10.21dbbea8.js"><link rel="prefetch" href="/purejing-blog/assets/js/11.ef9cf017.js"><link rel="prefetch" href="/purejing-blog/assets/js/12.b9a11f34.js"><link rel="prefetch" href="/purejing-blog/assets/js/14.13762fc4.js"><link rel="prefetch" href="/purejing-blog/assets/js/15.91591013.js"><link rel="prefetch" href="/purejing-blog/assets/js/16.e0ba67ae.js"><link rel="prefetch" href="/purejing-blog/assets/js/17.8e4e58d2.js"><link rel="prefetch" href="/purejing-blog/assets/js/18.3148689d.js"><link rel="prefetch" href="/purejing-blog/assets/js/19.5fad8ae6.js"><link rel="prefetch" href="/purejing-blog/assets/js/20.487ff4df.js"><link rel="prefetch" href="/purejing-blog/assets/js/21.aac47309.js"><link rel="prefetch" href="/purejing-blog/assets/js/22.9a4a92b3.js"><link rel="prefetch" href="/purejing-blog/assets/js/23.b2ce576c.js"><link rel="prefetch" href="/purejing-blog/assets/js/24.c3d851c9.js"><link rel="prefetch" href="/purejing-blog/assets/js/25.3cd38604.js"><link rel="prefetch" href="/purejing-blog/assets/js/26.98e94758.js"><link rel="prefetch" href="/purejing-blog/assets/js/27.fe287544.js"><link rel="prefetch" href="/purejing-blog/assets/js/28.c27cb912.js"><link rel="prefetch" href="/purejing-blog/assets/js/29.c0cba554.js"><link rel="prefetch" href="/purejing-blog/assets/js/30.a7d49573.js"><link rel="prefetch" href="/purejing-blog/assets/js/31.cbb98f51.js"><link rel="prefetch" href="/purejing-blog/assets/js/32.bf469fe0.js"><link rel="prefetch" href="/purejing-blog/assets/js/33.8a5bd06a.js"><link rel="prefetch" href="/purejing-blog/assets/js/34.e480ba7a.js"><link rel="prefetch" href="/purejing-blog/assets/js/35.fc7913e9.js"><link rel="prefetch" href="/purejing-blog/assets/js/36.5f097def.js"><link rel="prefetch" href="/purejing-blog/assets/js/37.de036ed3.js"><link rel="prefetch" href="/purejing-blog/assets/js/38.84e35cf3.js"><link rel="prefetch" href="/purejing-blog/assets/js/39.e47a3f9d.js"><link rel="prefetch" href="/purejing-blog/assets/js/4.c299cc82.js"><link rel="prefetch" href="/purejing-blog/assets/js/40.ee85e221.js"><link rel="prefetch" href="/purejing-blog/assets/js/41.b3650976.js"><link rel="prefetch" href="/purejing-blog/assets/js/42.03f70115.js"><link rel="prefetch" href="/purejing-blog/assets/js/43.72d28104.js"><link rel="prefetch" href="/purejing-blog/assets/js/5.29c43ca4.js"><link rel="prefetch" href="/purejing-blog/assets/js/7.08a34955.js"><link rel="prefetch" href="/purejing-blog/assets/js/8.f1c56df6.js"><link rel="prefetch" href="/purejing-blog/assets/js/9.0960bede.js"><link rel="prefetch" href="/purejing-blog/assets/js/vuejs-paginate.b1e5c227.js">
    <link rel="stylesheet" href="/purejing-blog/assets/css/0.styles.c06caa5c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/purejing-blog/" class="nav-link home-link">APureingJing </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/purejing-blog/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/purejing-blog/tag/" class="nav-link">Tags</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/purejing-blog/" class="nav-link mobile-home-link">APureingJing </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/purejing-blog/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/purejing-blog/tag/" class="nav-link">Tags</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        WEB鉴权机制
      </h1> <div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg> <span itemprop="name">APureingJing</span> <span itemprop="address">   in ShangHai</span></div> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2020-12-20T00:00:00.000Z">
      Sun Dec 20 2020
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-47ec96c3><a href="/purejing-blog/tag/浏览器" data-v-47ec96c3><span data-v-47ec96c3>浏览器</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><p>由于 HTTP 协议本身是无状态的，所以客户端同服务端通信时，服务端并不知道每次通信时，与之通信的是哪个客户端，再加上服务器资源并不是向所有用户开放的，而是仅对部分用户登陆，在这种情况下，实现用户的鉴权登陆是一种必要需求。</p> <p>开发中常用到用户鉴权登陆方式，一般有四种：</p> <ol><li>HTTP Basic Authentication</li> <li>session-cookie</li> <li>Token</li> <li>OAuth</li></ol> <h2 id="http-basic-authentication"><a href="#http-basic-authentication" class="header-anchor">#</a> HTTP Basic Authentication</h2> <p>这种方式会在客户端弹出一个登陆窗口，要求用户输入密码和密码进行登陆。但是这种方式使用 Base64 加密用户名和密码，所以安全性很低，已经不怎么使用了</p> <h2 id="session-cookie"><a href="#session-cookie" class="header-anchor">#</a> session-cookie</h2> <p>这种方式依赖 cookie 来使用。首次登陆时，用户输入用户名和密码，点击登陆，通过 post 请求将用户名和密码传给服务器，服务器验证身份后，会生成一个 sessions 的对象，然后根据用户名和密码生成一个加密过的 sessionId，将这个 sessionId 存入先前的 sessions 对象了，接着再把 sessionId 通过名为<code>set-cookie</code>的 HTTP Header，返回给客户端。之后客户端的每次请求，请求头都会带上这个 sessionId，服务器只需要去 sessions 里比对 sessionId，就知道是哪个用户了。</p> <h2 id="token"><a href="#token" class="header-anchor">#</a> Token</h2> <p>Token 是令牌的意思。以 Token 做用户标识，是在原生应用（App）兴起后。因为原生应用并没有浏览器环境，所以并没有 cookie，所以服务端在校验完客户端身份后，会直接生成一个 token 凭证，并且返回给客户端，让客户端自己保存。客户端每次请求服务器的时候，必须带上 token，服务器根据 token 来验证用户身份。最常用的 Token 令牌，就是 JWT，也就是 JSON Web Token。具体来说，Token 的验证，在服务器和客户端共发生了 6 次交互，过程如下：</p> <ol><li>客户端使用用户名跟密码请求登陆</li> <li>服务器收到请求，验证用户名和密码</li> <li>验证成功后，服务器签发 Token</li> <li>客户端接受 Token，并自己存储</li> <li>客户端再次请求服务器的时候，带上 Token</li> <li>服务器验证 Token，识别用户身份</li></ol> <p>JWT 则是使用较为广泛的一种 Token 方式。JWT 的信息主要有 3 部分：</p> <ol><li>headers： 描述 token 类别和加密算法</li> <li>claims：用户的一些信息，开发者自定义的字段</li> <li>signature：根据 headers 中指定的算法和私钥，在服务器进行加密而得到签名</li></ol> <h2 id="oauth"><a href="#oauth" class="header-anchor">#</a> OAuth</h2> <p>第三方平台授权登陆。常见于 Github 授权登陆 QQ、Google 授权登陆、微信授权登陆等。以 QQ 授权登陆，流程如下</p> <ol><li>客户端访问 QQ 鉴权服务器某个 url，向 QQ 鉴权服务器请求一个 code，这个 code 一般在页面回调后填入到了页面的 url</li> <li>使用 code，加上开发者的信息（AppID，AppSecret），向 QQ 鉴权服务器请求一个 access_token</li> <li>使用 access_token，去访问鉴权服务器的某些接口，获取用户的一些关键信息，如昵称、性别。</li></ol> <h2 id="单点登陆-single-sign-on"><a href="#单点登陆-single-sign-on" class="header-anchor">#</a> 单点登陆（Single Sign On）</h2> <p>相比于上面的单系统登录，sso 需要一个独立的认证中心，只有认证中心能接受用户的用户名密码等安全信息，其他系统不提供登录入口，只接受认证中心的间接授权。间接授权通过令牌实现，sso 认证中心验证用户的用户名密码没问题，创建授权令牌，在接下来的跳转过程中，授权令牌作为参数发送给各个子系统，子系统拿到令牌，即得到了授权，可以借此创建局部会话，局部会话登录方式与单系统的登录方式相同。这个过程，也就是单点登录的原理。</p> <h2 id="扫码登陆"><a href="#扫码登陆" class="header-anchor">#</a> 扫码登陆</h2> <p>现在扫码登陆特别流行，比如知乎、哔哩哔哩等 pc 端，都提供了扫码登陆的入口。那么扫码登陆是怎样做的呢？具体流程参考这张图：</p> <p><img src="/purejing-blog/assets/img/scan-login.5e96dd2e.png" alt="扫码登陆"></p> <p>扫码登陆可分为三个阶段：待扫描（pc 端生成二维码）、已扫描确认（App 端扫描确认）、已确认（pc 端已确认登陆）。</p> <h3 id="待扫描"><a href="#待扫描" class="header-anchor">#</a> 待扫描</h3> <p>待扫描阶段也就是流程图中 1~5 阶段，即生成二维码阶段，这个阶段跟移动端没有关系，是 PC 端跟服务端的交互过程</p> <p>首先 PC 端携带设备信息想服务端发起生成二维码请求，服务端会生成唯一的二维码 ID，你可以理解为 UUID，并且将 二维码 ID 跟 PC 设备信息关联起来，这跟移动端登录有点相似。
PC 端接受到二维码 ID 之后，将二维码 ID 以二维码的形式展示，等待移动端扫码。此时在 PC 端会启动一个定时器，轮询查询二维码的状态。如果移动端一直未扫描的话，那么一段时间后二维码将会失效。</p> <h2 id="已扫描确认阶段"><a href="#已扫描确认阶段" class="header-anchor">#</a> 已扫描确认阶段</h2> <p>流程图中第 6 ~ 10 阶段，手机扫 pc 端的二维码后，PC 端的二维码会变成已扫码，请在手机端确认。这个阶段是移动端跟服务端交互的过程。</p> <p>首先移动端扫描二维码，获取二维码 ID，然后将手机端登录的信息凭证（token）和 二维码 ID 作为参数发送给服务端，此时的手机一定是登录的，不存在没登录的情况。</p> <p>服务端接受请求后，会将 token 与二维码 ID 关联，为什么需要关联呢？你想想，我们使用微信时，移动端退出，PC 端是不是也需要退出，这个关联就是很有必要的。然后会生成一个一次性 token，这个 token 会返回给移动端，一次性 token 用作确认时候的凭证。</p> <p>此时，PC 端的定时器，会轮询到二维码的状态已经发生变化，会将 PC 端的二维码更新为已扫描，请确认。</p> <h2 id="已确认"><a href="#已确认" class="header-anchor">#</a> 已确认</h2> <p>流程图中的 第 11 ~ 15 步骤，这是扫码登录的最后阶段，移动端携带上一步骤中获取的临时 token ，确认登录，服务端校对完成后，会更新二维码状态，并且给 PC 端生成一个正式的 token ，后续 PC 端就是持有这个 token 访问服务端。</p> <p>PC 端的定时器，轮询到了二维码状态为登录状态，并且会获取到了生成的 token ，完成登录，后续访问都基于 token 完成。</p> <p>在服务器端会跟手机端一样，维护着 token 跟二维码、PC 设备信息、账号等信息。
到此，二维码扫描登录原理就差不多了，二维码扫描登录在原理上不难理解，跟 OAuth2.0 有一丝的相似之处，但是实现起来可能就比较复杂。</p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p>这一篇主要总结了 WEB 鉴权的常用方式，顺便学了下 SSO 和扫码登陆的相关知识点，对项目里做鉴权登陆提供了不少理论基础。</p></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#http-basic-authentication" title="HTTP Basic Authentication">HTTP Basic Authentication</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#session-cookie" title="session-cookie">session-cookie</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#token" title="Token">Token</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#oauth" title="OAuth">OAuth</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#单点登陆-single-sign-on" title="单点登陆（Single Sign On）">单点登陆（Single Sign On）</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#扫码登陆" title="扫码登陆">扫码登陆</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#待扫描" title="待扫描">待扫描</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#已扫描确认阶段" title="已扫描确认阶段">已扫描确认阶段</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#已确认" title="已确认">已确认</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#小结" title="小结">小结</a></div></div></div></div> <footer class="footer" data-v-0d7eaea6><div class="footer-left-wrap" data-v-0d7eaea6><ul class="contact" data-v-0d7eaea6></ul></div> <div class="footer-right-wrap" data-v-0d7eaea6><ul class="copyright" data-v-0d7eaea6></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/purejing-blog/assets/js/app.1ccd296c.js" defer></script><script src="/purejing-blog/assets/js/6.a2607acc.js" defer></script><script src="/purejing-blog/assets/js/3.f5077034.js" defer></script><script src="/purejing-blog/assets/js/13.f515bb59.js" defer></script>
  </body>
</html>
